<?xml version="1.0" encoding="utf-8" ?>

<Sqls>
  <Sql>
    <key>GetById</key>
    <query>
      SELECT
      PERIDCCODI
      ,PERIDCANIO
      ,PERIDCMES
      ,PERIDCNOMBRE
      ,PERIDCANIOMES
      ,PERIDCFECREGI
      ,PERIDCUSUARIOREGI
      ,PERIDCESTADO
      ,PERIDCNUEVO
      FROM TRN_PERIODO_DECLARACION
      WHERE PERIDCCODI=:PERIDCCODI
    </query>
  </Sql>
  <Sql>
    <key>GetListaCombobox</key>
    <query>
      SELECT PERIDCCODI
      ,PERIDCNOMBRE
      FROM TRN_PERIODO_DECLARACION
      ORDER BY  PERIDCCODI DESC
    </query>
  </Sql>

  <Sql>
    <key>GetListaPeriodoDeclaracion</key>
    <query>
      SELECT PERIDCCODI
      ,PERIDCANIO
      ,PERIDCMES
      ,PERIDCNOMBRE
      ,PERIDCANIOMES
      ,PERIDCFECREGI
      ,PERIDCUSUARIOREGI
      ,VEST.ESTDDESCRIPCION   PERIDCESTADO
      ,PERIDCESTADO           ESTDABREV
      ,PERIDCNUEVO
      FROM TRN_PERIODO_DECLARACION PDC
      INNER JOIN VTP_ESTADO        VEST
      ON PDC.PERIDCESTADO=VEST.ESTDABREV
      ORDER BY PDC.PERIDCCODI DESC
    </query>
  </Sql>

  <Sql>
    <key>SaveUpdate</key>
    <query>

		DECLARE
		P_PERIDCCODI_AUX NUMBER :=0;
		P_PERIDCCODI NUMBER :=:PERIDCCODI;
		P_PERIDCANIO NUMBER :=:PERIDCANIO;
		P_PERIDCMES  NUMBER :=:PERIDCMES;
		P_PERIDCNOMBRE  VARCHAR2(400):=:PERIDCNOMBRE;
		P_PERIDCANIOMES  VARCHAR2(400):='';
		P_PERIDCUSUARIOREGI VARCHAR2(400):=:PERIDCUSUARIOREGI;
		P_PERIDCESTADO CHAR(3):=:PERIDCESTADO;
		P_MENSAJE VARCHAR2(500):=NULL;
		P_ANIOAUX NUMBER:=0;
		P_MESAUX NUMBER:=0;
		P_TRNPCTCODI NUMBER:=0;
		BEGIN

		IF P_PERIDCESTADO='ABI' AND P_PERIDCCODI = 0
		THEN

		SELECT MAX(PERIDCANIO)  INTO  P_ANIOAUX FROM TRN_PERIODO_DECLARACION;

		SELECT CASE WHEN MAX(PERIDCMES)=12 THEN MAX(PERIDCANIO) +1 ELSE MAX(PERIDCANIO) END INTO  P_ANIOAUX
		FROM TRN_PERIODO_DECLARACION
		WHERE PERIDCANIO=P_ANIOAUX;

		IF(P_PERIDCANIO!=(P_ANIOAUX))
		THEN
		SELECT 'El año ingresado debe ser '||TO_CHAR(P_ANIOAUX) INTO P_MENSAJE FROM DUAL;
		ELSE

		SELECT(SELECT NVL(MAX(PERIDCMES),0)+1  FROM TRN_PERIODO_DECLARACION   WHERE PERIDCANIO=P_ANIOAUX)INTO P_MESAUX FROM DUAL;

		SELECT (CASE WHEN P_MESAUX=P_PERIDCMES
		THEN NULL
		ELSE
		'El mes seleccionado no es el correcto, seleccione el mes'||' '||TO_CHAR(TO_DATE(P_MESAUX, 'MM'), 'Month','nls_date_language=spanish')
		END)
		INTO P_MENSAJE  FROM DUAL;

		END IF;
		END IF;

		IF P_MENSAJE IS NULL
		THEN
		IF P_PERIDCESTADO='ABI' AND P_PERIDCCODI = 0
		THEN
		-- SI ES IGUAL A 0
		IF(P_PERIDCCODI=0)
		THEN
		SELECT (
		SELECT NVL(MAX(PERIDCCODI),0)
		FROM TRN_PERIODO_DECLARACION
		) INTO P_PERIDCCODI_AUX
		FROM DUAL;

		SELECT (P_PERIDCCODI_AUX+1) INTO P_PERIDCCODI
		FROM DUAL;

		--SELECT TO_CHAR(P_PERIDCANIO)||'.'|| TO_CHAR(TO_DATE(P_PERIDCMES, 'MM'), 'Month') INTO  P_PERIDCNOMBRE FROM DUAL;
		SELECT TO_CHAR(P_PERIDCANIO)|| SUBSTR(TO_CHAR('00'||P_PERIDCMES),-2,2) INTO  P_PERIDCANIOMES FROM DUAL;

		INSERT INTO TRN_PERIODO_DECLARACION
		(PERIDCCODI
		,PERIDCANIO
		,PERIDCMES
		,PERIDCNOMBRE
		,PERIDCANIOMES
		,PERIDCFECREGI
		,PERIDCUSUARIOREGI
		,PERIDCESTADO
		,PERIDCNUEVO)
		VALUES(P_PERIDCCODI
		,P_PERIDCANIO
		,P_PERIDCMES
		,P_PERIDCNOMBRE
		,P_PERIDCANIOMES
		,SYSDATE
		,P_PERIDCUSUARIOREGI
		,P_PERIDCESTADO
		,1);

		--UPDATE TRN_PERIODO_DECLARACION SET PERIDCESTADO='CER'  WHERE PERIDCCODI&lt;P_PERIDCCODI;
		
		INSERT INTO VTP_CODIGO_CONSOLIDADO_PERIODO
		(
		PERIDCCODI,
		CODCNCODIVTP    ,
		COREGECODI      ,
		CODCNPEFECREGI  ,
		CODCNPEUSUARIOREGI,
		CODCNPEESTADO,
		EMPRCODI
		)
		SELECT DISTINCT P_PERIDCCODI
		,VCNP.CODCNCODIVTP
		,VCNP.COREGECODI
		,SYSDATE
		,P_PERIDCUSUARIOREGI
		,'ACT'
		,SOLGN.EMPRCODI
		FROM VTP_CODIGO_CONSOLIDADO_PERIODO  VCNP
		INNER JOIN VTP_CODIGO_CONSOLIDADO VCN
		ON VCNP.CODCNCODIVTP=VCN.CODCNCODIVTP
		AND VCNP.EMPRCODI=VCN.EMPRCODI
		LEFT JOIN (SELECT SEMP.EMPRNOMB        AS EMPRESA
		,RGN.COREGECODI
		,RGN.COREGECODVTP
		,RGN.COREGEESTADO
		,RTSL.CORESOFECHAINICIO
		,RTSL.CORESOFECHAFIN
		,SEMP.EMPRCODI
		FROM VTP_CODIGO_RETIRO_GENERADO RGN
		INNER JOIN VTP_CODIGO_RETIRO_SOL_DET  SDT
		ON RGN.CORESDCODI=SDT.CORESDCODI
		INNER JOIN TRN_CODIGO_RETIRO_SOLICITUD RTSL
		ON SDT.CORESOCODI=RTSL.CORESOCODI
		INNER JOIN VW_SI_EMPRESA    SEMP
		ON RTSL.GENEMPRCODI=SEMP.EMPRCODI
		) SOLGN
		ON (VCN.EMPRCODI=SOLGN.EMPRCODI
		AND VCN.CODCNCODIVTP=SOLGN.COREGECODVTP)
		WHERE PERIDCCODI IN(
		SELECT PERIDCCODI
		FROM TRN_PERIODO_DECLARACION
		where PERIDCCODI &lt;P_PERIDCCODI
      )
      AND VCNP.COREGECODI IS NULL
      AND (SOLGN.COREGEESTADO IN('ACT','PAP','PVT') OR SOLGN.COREGEESTADO IS NULL )
      AND (TO_CHAR(NVL(SOLGN.CORESOFECHAINICIO,VCN.CODCNFECINICIO),'yyyymm')&lt;=TO_NUMBER(P_PERIDCANIOMES)
      AND TO_CHAR(NVL(SOLGN.CORESOFECHAFIN,VCN.CODCNFECFIN),'yyyymm') &gt;=TO_NUMBER(P_PERIDCANIOMES)
      );



      INSERT INTO VTP_CODIGO_CONSOLIDADO_PERIODO
      (
      PERIDCCODI,
      CODCNCODIVTP    ,
      COREGECODI      ,
      CODCNPEFECREGI  ,
      CODCNPEUSUARIOREGI,
      CODCNPEESTADO,
      EMPRCODI
      )
      SELECT DISTINCT  P_PERIDCCODI
      ,VCP.CODCNCODIVTP
      ,VCP.COREGECODI
      ,SYSDATE
      ,P_PERIDCUSUARIOREGI
      ,'ACT'
      ,SEMP.EMPRCODI
      FROM VTP_CODIGO_RETIRO_GENERADO RGN
      INNER JOIN VTP_CODIGO_RETIRO_SOL_DET  SDT
      ON RGN.CORESDCODI=SDT.CORESDCODI
      INNER JOIN TRN_CODIGO_RETIRO_SOLICITUD RTSL
      ON SDT.CORESOCODI=RTSL.CORESOCODI
      INNER JOIN VW_SI_EMPRESA    SEMP
      ON RTSL.GENEMPRCODI=SEMP.EMPRCODI
      INNER JOIN VTP_CODIGO_CONSOLIDADO_PERIODO VCP
      ON RGN.COREGECODI=VCP.COREGECODI
      WHERE (
      RGN.COREGEESTADO IN('ACT','PAP','PVT') OR RGN.COREGEESTADO IS NULL )
      AND PERIDCCODI  IN(SELECT PERIDCCODI FROM TRN_PERIODO_DECLARACION where PERIDCCODI &lt;P_PERIDCCODI)
      AND (TO_CHAR(RTSL.CORESOFECHAINICIO,'yyyymm')&lt;=TO_NUMBER(P_PERIDCANIOMES)
      AND TO_CHAR(RTSL.CORESOFECHAFIN,'yyyymm') &gt;=TO_NUMBER(P_PERIDCANIOMES)
      );


      ----------------------------------------------------------------------------------------
      -- Si hay en periodos vencidos en su periodo actual
      -----------------------------------------------------------------------------------------


      BEGIN
      For coreso in (
      SELECT PRD.PERIDCCODI
      ,RSL.CORESOCODI
      FROM TRN_CODIGO_CONSOLIDADO_PERIODO PRD
      INNER JOIN TRN_CODIGO_RETIRO_SOLICITUD RSL
      ON PRD.CORESOCODI=RSL.CORESOCODI
      LEFT JOIN (
      SELECT CPR.CORESOCODI
      , RSL.CORESOFECHAINICIO
      , RSL.CORESOFECHAFIN
      ,CPR.PERIDCCODI
      FROM TRN_CODIGO_CONSOLIDADO_PERIODO CPR
      INNER JOIN TRN_CODIGO_RETIRO_SOLICITUD RSL
      ON CPR.CORESOCODI=RSL.CORESOCODI
      INNER JOIN TRN_PERIODO_DECLARACION PRD
      ON PRD.PERIDCCODI=CPR.PERIDCCODI
      WHERE CPR.PERIDCCODI &lt;P_PERIDCCODI
      AND to_char(RSL.CORESOFECHAINICIO , 'YYYYMM') &lt;= PERIDCANIO|| SUBSTR('0'||PERIDCMES,-2,2)
      and   to_char(RSL.CORESOFECHAFIN,'YYYYMM') &gt;= PERIDCANIO|| SUBSTR('0'||PERIDCMES,-2,2)
      ) SOL
      ON PRD.PERIDCCODI=SOL.PERIDCCODI
      AND PRD.CORESOCODI=SOL.CORESOCODI
      WHERE SOL.CORESOCODI IS NULL
      AND RSL.CORESOESTADO='ACT'
      AND PRD.CODCNPEESTADO='ACT'
      AND  PRD.PERIDCCODI &lt;P_PERIDCCODI
      )

      LOOP 
      Update TRN_CODIGO_CONSOLIDADO_PERIODO set CODCNPEESTADO = 'INA'  WHERE CORESOCODI=coreso.CORESOCODI and PERIDCCODI=coreso.PERIDCCODI;
      END LOOP;
      END;



      BEGIN
      For i in (
      SELECT PRD.PERIDCCODI
      ,RTG.COREGECODI
      FROM TRN_CODIGO_CONSOLIDADO_PERIODO PRD
      INNER JOIN TRN_CODIGO_RETIRO_SOLICITUD RSL
      ON PRD.CORESOCODI=RSL.CORESOCODI
      INNER JOIN VTP_CODIGO_RETIRO_SOL_DET SLD
      ON PRD.CORESOCODI=SLD.CORESOCODI
      INNER JOIN VTP_CODIGO_RETIRO_GENERADO RTG
      ON SLD.CORESDCODI=RTG.CORESDCODI
      LEFT JOIN (
      SELECT CPR.CORESOCODI
      ,CPR.PERIDCCODI
      FROM TRN_CODIGO_CONSOLIDADO_PERIODO CPR
      INNER JOIN TRN_CODIGO_RETIRO_SOLICITUD RSL
      ON CPR.CORESOCODI=RSL.CORESOCODI
      INNER JOIN TRN_PERIODO_DECLARACION PRD
      ON PRD.PERIDCCODI=CPR.PERIDCCODI
      WHERE PRD.PERIDCCODI &lt;P_PERIDCCODI AND  to_char(RSL.CORESOFECHAINICIO, 'YYYYMM') &lt;= PERIDCANIO|| SUBSTR('0'||PERIDCMES,-2,2)
      and   to_char(RSL.CORESOFECHAFIN,'YYYYMM') &gt;= PERIDCANIO|| SUBSTR('0'||PERIDCMES,-2,2)
      ) SOL
      ON PRD.PERIDCCODI=SOL.PERIDCCODI
      AND PRD.CORESOCODI=SOL.CORESOCODI
      WHERE SOL.CORESOCODI IS NULL
      AND RSL.CORESOESTADO='ACT'
      AND PRD.CODCNPEESTADO='ACT'
      AND  PRD.PERIDCCODI &lt;P_PERIDCCODI
      )
      LOOP
      Update VTP_CODIGO_CONSOLIDADO_PERIODO set CODCNPEESTADO = 'INA'  WHERE COREGECODI = i.COREGECODI AND PERIDCCODI=i.PERIDCCODI;
      END LOOP;
      END;


      ----------------------------------------------------------------------------------------
      -- Potencia Contratada
      -----------------------------------------------------------------------------------------


      -- CREATE GLOBAL TEMPORARY TABLE TRN_CODIGO_CONSOLIDADO_PERIODO_TEMP_V1
      -- ON COMMIT PRESERVE ROWS
      -- AS
      INSERT INTO TRN_CODIGO_CONSOLIDADO_PERIODO
      (
      PERIDCCODI,
      CORESOCODI,
      CODCNCODIVTA    ,
      CODCNPEFECREGI  ,
      CODCNPEUSUARIOREGI,
      CODCNPEESTADO,
      EMPRCODI,
      TRNPCTIPOPOTENCIA
      )
      SELECT DISTINCT  P_PERIDCCODI,
      RSL.CORESOCODI,
      CODCNCODIVTA    ,
      SYSDATE  ,
      P_PERIDCUSUARIOREGI,
      'ACT',
      RTSL.GENEMPRCODI,
      RSL.TRNPCTIPOPOTENCIA
      FROM TRN_CODIGO_CONSOLIDADO_PERIODO RSL
      INNER JOIN TRN_CODIGO_RETIRO_SOLICITUD RTSL
      ON RSL.CORESOCODI=RTSL.CORESOCODI
      WHERE RTSL.CORESOESTADO IN('ACT','GEN','ASI')
      AND (TO_CHAR(RTSL.CORESOFECHAINICIO,'yyyymm')&lt;=TO_NUMBER(P_PERIDCANIOMES)
      AND TO_CHAR(RTSL.CORESOFECHAFIN,'yyyymm') &gt;=TO_NUMBER(P_PERIDCANIOMES))
      AND RSL.PERIDCCODI IN(
      SELECT PERIDCCODI
      FROM TRN_PERIODO_DECLARACION
      where PERIDCCODI &lt;P_PERIDCCODI
      )
      UNION
      SELECT DISTINCT  P_PERIDCCODI,
      RSL.CORESOCODI,
      CODCNCODIVTA    ,
      SYSDATE  ,
      P_PERIDCUSUARIOREGI,
      'ACT',
      RTSL.GENEMPRCODI,
      RSL.TRNPCTIPOPOTENCIA
      FROM TRN_CODIGO_CONSOLIDADO_PERIODO RSL
      INNER JOIN TRN_CODIGO_RETIRO_SOLICITUD RTSL
      ON RSL.CORESOCODI=RTSL.CORESOCODI
      WHERE RTSL.CORESOESTADO IN('PAP','PVT')
      -- AND (TO_CHAR(RTSL.CORESOFECHAINICIO,'yyyymm')&lt;=TO_NUMBER(P_PERIDCANIOMES)
    --  AND TO_CHAR(RTSL.CORESOFECHAFIN,'yyyymm') &gt;=TO_NUMBER(P_PERIDCANIOMES))
      AND RSL.PERIDCCODI IN(
      SELECT PERIDCCODI
      FROM TRN_PERIODO_DECLARACION
      where PERIDCCODI &lt;P_PERIDCCODI
		)
		;


		SELECT NVL((SELECT MAX(TRNPCTCODI) FROM TRN_POTENCIA_CONTRATADA),0) INTO P_TRNPCTCODI
		FROM DUAL;

		INSERT INTO TRN_POTENCIA_CONTRATADA
		(
		"TRNPCTCODI",
		--"PERICODI" ,
		PERIDCCODI,
		"EMPRCODI" ,
		"CORESOCODI" ,
		"TRNPCTPTOSUMINS" ,
		"TRNPCTTOTALMWFIJA" ,
		"TRNPCTHPMWFIJA" ,
		"TRNPCTHFPMWFIJA",
		"TRNPCTTOTALMWVARIABLE",
		"TRNPCTHPMWFIJAVARIABLE" ,
		"TRNPCTHFPMWFIJAVARIABLE",
		"TRNPCTCOMEOBS" ,
		"TRNPCTUSERNAMEINS" ,
		"TRNPCTFECINS" ,
		"COREGECODI"  ,
		"TRNPCAGRP"  ,
		"TRNPCNUMORD"  ,
		"TRNPCCODICAS"  ,
		"TRNPCESTADO"  ,
		"TRNPCEXCEL"  ,
		"TRNPCENVCODI" )
		SELECT
		P_TRNPCTCODI + (row_number() over (order by  TRNPCTCODI )),
		P_PERIDCCODI ,
		"EMPRCODI" ,
		PTN.CORESOCODI ,
		"TRNPCTPTOSUMINS" ,
		"TRNPCTTOTALMWFIJA" ,
		"TRNPCTHPMWFIJA" ,
		"TRNPCTHFPMWFIJA",
		"TRNPCTTOTALMWVARIABLE",
		"TRNPCTHPMWFIJAVARIABLE" ,
		"TRNPCTHFPMWFIJAVARIABLE",
		"TRNPCTCOMEOBS" ,
		P_PERIDCUSUARIOREGI ,
		"TRNPCTFECINS" ,
		"COREGECODI"  ,
		"TRNPCAGRP"  ,
		"TRNPCNUMORD"  ,
		"TRNPCCODICAS"  ,
		"TRNPCESTADO"  ,
		"TRNPCEXCEL"  ,
		"TRNPCENVCODI"
		FROM TRN_POTENCIA_CONTRATADA PTN
		WHERE NVL(PERIDCCODI,PERICODI)=P_PERIDCCODI_AUX and coresocodi not in (select coresocodi FROM TRN_POTENCIA_CONTRATADA PTN2 wHERE NVL(PERIDCCODI,PERICODI)=P_PERIDCCODI);

		-- POTENCIAS CONTRATADAS DE MESES ANTERIORES QUE NO SE REPLICAN DEL ULTIMO MES

		SELECT NVL((SELECT MAX(TRNPCTCODI) FROM TRN_POTENCIA_CONTRATADA),0) INTO P_TRNPCTCODI
		FROM DUAL;

		INSERT INTO TRN_POTENCIA_CONTRATADA
		(
		"TRNPCTCODI",
		--"PERICODI" ,
		PERIDCCODI,
		"EMPRCODI" ,
		"CORESOCODI" ,
		"TRNPCTPTOSUMINS" ,
		"TRNPCTTOTALMWFIJA" ,
		"TRNPCTHPMWFIJA" ,
		"TRNPCTHFPMWFIJA",
		"TRNPCTTOTALMWVARIABLE",
		"TRNPCTHPMWFIJAVARIABLE" ,
		"TRNPCTHFPMWFIJAVARIABLE",
		"TRNPCTCOMEOBS" ,
		"TRNPCTUSERNAMEINS" ,
		"TRNPCTFECINS" ,
		"COREGECODI"  ,
		"TRNPCAGRP"  ,
		"TRNPCNUMORD"  ,
		"TRNPCCODICAS"  ,
		"TRNPCESTADO"  ,
		"TRNPCEXCEL"  ,
		"TRNPCENVCODI" )
		SELECT
		P_TRNPCTCODI + (row_number() over (order by  TRNPCTCODI )),
		P_PERIDCCODI ,
		"EMPRCODI" ,
		PTN.CORESOCODI ,
		"TRNPCTPTOSUMINS" ,
		"TRNPCTTOTALMWFIJA" ,
		"TRNPCTHPMWFIJA" ,
		"TRNPCTHFPMWFIJA",
		"TRNPCTTOTALMWVARIABLE",
		"TRNPCTHPMWFIJAVARIABLE" ,
		"TRNPCTHFPMWFIJAVARIABLE",
		"TRNPCTCOMEOBS" ,
		P_PERIDCUSUARIOREGI ,
		"TRNPCTFECINS" ,
		"COREGECODI"  ,
		"TRNPCAGRP"  ,
		"TRNPCNUMORD"  ,
		"TRNPCCODICAS"  ,
		"TRNPCESTADO"  ,
		"TRNPCEXCEL"  ,
		"TRNPCENVCODI"
		FROM TRN_POTENCIA_CONTRATADA PTN
		where concat(nvl(pericodi,peridccodi),coresocodi)  in (
		select concat(max(nvl(pericodi,peridccodi)), coresocodi) from  TRN_POTENCIA_CONTRATADA
		where coresocodi in (
		select coresocodi from TRN_CODIGO_CONSOLIDADO_PERIODO where peridccodi=P_PERIDCCODI
		and concat( peridccodi, coresocodi) not in (
		select distinct(concat(nvl(pericodi,peridccodi), coresocodi)) from TRN_POTENCIA_CONTRATADA where nvl(pericodi,peridccodi)=P_PERIDCCODI
		)
		)
		group by coresocodi
		);




		END IF;

		ELSIF  P_PERIDCESTADO IN('CER','ABI') AND P_PERIDCCODI > 0 THEN
		UPDATE TRN_PERIODO_DECLARACION SET PERIDCESTADO=P_PERIDCESTADO WHERE PERIDCCODI=P_PERIDCCODI;
		END IF;
		END IF;

		SELECT P_MENSAJE INTO :MENSAJE FROM DUAL;
		END;

	</query>
  </Sql>


</Sqls>

