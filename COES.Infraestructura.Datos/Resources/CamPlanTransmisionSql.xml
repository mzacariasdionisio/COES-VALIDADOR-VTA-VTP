<?xml version="1.0" encoding="utf-8" ?>
<Sqls>
	<Sql>
		<key>GetPlanTransmision</key>
		<query>
			SELECT * FROM CAM_PLANTRANSMISION WHERE IND_DEL = :IND_DEL ORDER BY PLANCODI ASC
		</query>
	</Sql>


	<Sql>
		<key>SavePlanTransmision</key>
		<query>
			INSERT INTO CAM_PLANTRANSMISION (
			PLANCODI,
			PERICODI,
			CODEMPRESA,
			NOMEMPRESA,
			NUMREG,
			PLANVERSION,
			PLANESTADO,
			PLANCUMPLIMIENTO,
			VIGENTE,
			USU_CREACION,
			FEC_CREACION,
			IND_DEL,
			CORREOUSU
			) VALUES (
			:PLANCODI,
			:PERICODI,
			:CODEMPRESA,
			:DESEMPRESA,
			:NUMREG,
			:PLANVERSION,
			:PLANESTADO,
			:PLANCUMPLIMIENTO,
			:VIGENTE,
			:USU_CREACION,
			:FEC_CREACION,
			:IND_DEL,
			:CORREOUSU
			)
		</query>
	</Sql>

	<Sql>
		<key>UpdatePlanTransmision</key>
		<query>
			UPDATE CAM_PLANTRANSMISION
			SET
			CODEMPRESA = :CODEMPRESA,
			PERICODI = :PERICODI,
			NOMEMPRESA = :NOMEMPRESA,
			FECENVIO = :FECENVIO,
			NUMREG = :NUMREG,
			PLANVERSION = :PLANVERSION,
			PLANESTADO = :PLANESTADO,
			PLANCUMPLIMIENTO = :PLANCUMPLIMIENTO,
			VIGENTE = :VIGENTE,
			USU_MODIFICACION = :USU_MODIFICACION,
			FEC_MODIFICACION = :FEC_MODIFICACION
			WHERE
			PLANCODI = :PLANCODI
		</query>
	</Sql>

	<Sql>
		<key>GetLastPlanTransmisionId</key>
		<query>
			SELECT * FROM CAM_PLANTRANSMISION
			ORDER BY PLANCODI DESC
			FETCH FIRST 1 ROWS ONLY
		</query>
	</Sql>


	<Sql>
		<key>DeletePlanTransmisionById</key>
		<query>
			UPDATE CAM_PLANTRANSMISION SET IND_DEL = :IND_DEL,  USU_MODIFICACION = :USU_MODIFICACION, FEC_MODIFICACION = :FEC_MODIFICACION WHERE PLANCODI = :ID
		</query>
	</Sql>

	<Sql>
		<key>GetPlanTransmisionById</key>
		<query>
			SELECT PLAN.*, PERI.PERINOMBRE FROM CAM_PLANTRANSMISION PLAN INNER JOIN CAM_PERIODO PERI ON PERI.PERICODI = PLAN.PERICODI WHERE PLAN.PLANCODI = :ID AND PLAN.IND_DEL = :IND_DEL
		</query>
	</Sql>

	<Sql>
		<key>GetPlanTransmisionByFilters</key>
		<query>
			SELECT P.PLANCODI, CP.PERICODI, CP.PERINOMBRE, P.CODEMPRESA, P.NOMEMPRESA, P.FECENVIO, P.NUMREG,
			P.PLANVERSION, P.PLANESTADO, P.PLANCUMPLIMIENTO, P.VIGENTE, CP.PERICODI, CP.PERINOMBRE, P.IND_DEL, P.CORREOUSU
			FROM CAM_PLANTRANSMISION P
			INNER JOIN CAM_PERIODO CP ON P.PERICODI = CP.PERICODI
			WHERE P.PLANCODI = :PLANCODI
			AND P.IND_DEL = :IND_DEL
		</query>
	</Sql>

	<Sql>
		<key>GetPlanTransmisionByEstado</key>
		<query>
			SELECT * 
			FROM CAM_PLANTRANSMISION 
			WHERE IND_DEL = :IND_DEL 
			AND (PLANESTADO != :ESTADOEXCL)
			AND (PERICODI = :PERIODO)
			AND (:EMPRESA = 0 OR CODEMPRESA = :EMPRESAT)
			AND (:ESTADO = 'T' OR PLANESTADO = :ESTADOT)
			AND (:VIGENTE = 'T' OR VIGENTE = :VIGENTET)
			AND (:FUERAPLAZO = 'T' OR PLANCUMPLIMIENTO = :FUERAPLAZOT)
			ORDER BY CODEMPRESA, FECENVIO DESC
		</query>
	</Sql>

	<Sql>
		<key>DesactivatePlanById</key>
		<query>
			UPDATE CAM_PLANTRANSMISION 
			SET VIGENTE = :VIGENTE 
			WHERE PERICODI IN (
				SELECT PERICODI 
				FROM CAM_PLANTRANSMISION 
				WHERE PLANCODI = :IDD
			) 
			AND CODEMPRESA IN (
				SELECT CODEMPRESA 
				FROM CAM_PLANTRANSMISION 
				WHERE PLANCODI = :ID
			)
			AND IND_DEL = :IND_DEL
		</query>
	</Sql>

	<Sql>
		<key>ActivatePlanById</key>
		<query>
			UPDATE CAM_PLANTRANSMISION SET VIGENTE = :VIGENTE WHERE PLANCODI = :ID
		</query>
	</Sql>
	<Sql>
		<key>UpdatePlanEstadoById</key>
		<query>
			UPDATE CAM_PLANTRANSMISION SET PLANESTADO = :PLANESTADO WHERE PLANCODI = :ID
		</query>
	</Sql>
	<Sql>
		<key>UpdatePlanEstadoEnviarById</key>
		<query>
			UPDATE CAM_PLANTRANSMISION 
			SET PLANESTADO = :PLANESTADO, 
				FECENVIO = :FECENVIO,
				PLANCUMPLIMIENTO = CASE 
					WHEN :FECENVIOP BETWEEN (SELECT PERIFECHAINICIO FROM CAM_PERIODO WHERE PERICODI IN (SELECT PERICODI FROM CAM_PLANTRANSMISION WHERE PLANCODI = :IDFI)) 
									AND (SELECT PERIFECHAFIN FROM CAM_PERIODO WHERE PERICODI IN (SELECT PERICODI FROM CAM_PLANTRANSMISION WHERE PLANCODI = :IDFF)) 
					THEN 'En plazo' 
					ELSE 'Fuera de plazo'
				END,
				PLANVERSION = (SELECT COALESCE(MAX(PLANVERSION), 0) + 1 AS NUEVA_PLANVERSION
					FROM CAM_PLANTRANSMISION
					WHERE CODEMPRESA = (SELECT CODEMPRESA FROM CAM_PLANTRANSMISION WHERE PLANCODI = :IDE)
					AND PERICODI = (SELECT PERICODI FROM CAM_PLANTRANSMISION WHERE PLANCODI = :IDP)),
				CORREOUSU = :CORREOUSU
			WHERE PLANCODI = :ID AND IND_DEL = :IND_DEL
		</query>
	</Sql>
	<Sql>
		<key>GetPlanTransmisionByEstadoVigente</key>
		<query>
			SELECT PL.*,PR.PROYCODI, PR.PROYNOMBRE, PR.TIPOCODI, PR.TIPOFICODI, PR.PROYESTADO, PR.FECHAENVIOOBS, TP.TIPONOMBRE, TF.TIPOFINOMBRE FROM CAM_PLANTRANSMISION PL INNER JOIN CAM_TRNSMPROYECTO PR ON PL.PLANCODI = PR.PLANCODI AND PR.IND_DEL=:IND_DELP INNER JOIN CAM_TIPOPROYECTO TP ON PR.TIPOCODI = TP.TIPOCODI LEFT JOIN CAM_TIPOFICHAPROYECTO TF ON PR.TIPOFICODI = TF.TIPOFICODI WHERE PL.IND_DEL = :IND_DEL AND (PR.PROYESTADO != :ESTADOEXCL) AND (PL.PERICODI = :PERIODO)
			AND EXISTS (
				SELECT 1 FROM DUAL
				WHERE INSTR(:EMPRESA, PL.CODEMPRESA) > 0
			)
			AND EXISTS (
				SELECT 1 FROM DUAL
				WHERE INSTR(:TIPOPROYECTO, PR.TIPOCODI) > 0
			)
			AND (
				(PR.TIPOCODI = 1 AND EXISTS (
					SELECT 1 
					FROM DUAL 
					WHERE INSTR(:SUBTIPOPROYECTO, PR.TIPOFICODI) > 0
				)) 
				OR PR.TIPOCODI != 1
			)
			AND (:ESTADO = 'T' OR PR.PROYESTADO = :ESTADOT) ORDER BY PL.CODEMPRESA, PL.FECENVIO DESC	
		</query>
	</Sql>
	<Sql>
		<key>GetPlanTransmisionByVigente</key>
		<query>
			SELECT * 
			FROM CAM_PLANTRANSMISION 
			WHERE IND_DEL = :IND_DEL 
			AND (PLANESTADO != :ESTADOEXCL)
			AND (PERICODI = :PERIODO)
			AND (VIGENTE = :VIGENTE)
			AND EXISTS (
				SELECT 1 FROM DUAL
				WHERE INSTR(:EMPRESA, CODEMPRESA) > 0
			)
			AND (:ESTADO = 'T' OR PLANESTADO = :ESTADOT)
			ORDER BY CODEMPRESA, FECENVIO DESC		
		</query>
	</Sql>
	<Sql>
		<key>UpdateProyRegById</key> 
		<query>
			UPDATE CAM_PLANTRANSMISION 
			SET NUMREG = (
				SELECT COALESCE(COUNT(*), 0) 
				FROM CAM_TRNSMPROYECTO 
				WHERE PLANCODI = :ID AND IND_DEL = :IND_DEL
			)
			WHERE PLANCODI = :IDD
		</query>
	</Sql>
</Sqls>

