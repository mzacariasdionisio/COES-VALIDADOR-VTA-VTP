<?xml version="1.0" encoding="utf-8" ?>
<Sqls>
	<Sql>
		<key>GetMaxId</key>
		<query>
			select nvl(max(EPSUBECODI), 0) + 1 from EPR_SUBESTACION
		</query>
	</Sql>
	<Sql>
		<key>Update</key>
		<query>
			update EPR_SUBESTACION set
			AREACODI = :Areacodi,
			EPPROYCODI = :Epproycodi,
			EPSUBEMOTIVO = :Epsubemotivo,
			EPSUBEFECHA= TO_DATE(:Epsubefecha, 'DD/MM/YYYY'),
			EPSUBEMEMORIACALCULO= :Epsubememoriacalculo,
			EPSUBEESTREGISTRO = :Epsubeestregistro,
			EPSUBEUSUMODIFICACION = :Epsubeusumodificacion,
			EPSUBEFECMODIFICACION = sysdate
			where EPSUBECODI = :Epsubecodi
		</query>
	</Sql>
	<Sql>
		<key>UpdateAuditoria</key>
		<query>
			update EPR_SUBESTACION set
			EPSUBEESTREGISTRO = :Epsubeestregistro,
			EPSUBEUSUMODIFICACION = :Epsubeusumodificacion,
			EPSUBEFECMODIFICACION = sysdate
			where EPSUBECODI = :Epsubecodi
		</query>
	</Sql>

	<Sql>
		<key>Save</key>
		<query>
			insert into EPR_SUBESTACION(
			EPSUBECODI,
			AREACODI,
			EPPROYCODI,
			EPSUBEMOTIVO,
			EPSUBEFECHA,
			EPSUBEMEMORIACALCULO,
			EPSUBEESTREGISTRO,
			EPSUBEUSUCREACION,
			EPSUBEFECCREACION
			)
			values(
			:Epsubecodi,
			:Areacodi,
			:Epproycodi,
			:Epsubemotivo,
			TO_DATE(:Epsubefecha, 'DD/MM/YYYY'),
			:Epsubememoriacalculo,
			:Epsubeestregistro,
			:Epsubeusucreacion,
			sysdate
			)
		</query>
	</Sql>
	<Sql>
		<key>GetById</key>
		<query>
			SELECT
			EPSUBECODI,
			AREACODI,
			EPPROYCODI,
			EPSUBEMOTIVO,
			TO_CHAR(EPSUBEFECHA, 'DD/MM/YYYY') AS EPSUBEFECHA,
			EPSUBEMEMORIACALCULO,
			EPSUBEESTREGISTRO,
			EPSUBEUSUCREACION,
			EPSUBEFECCREACION,
			EPSUBEUSUMODIFICACION,
			EPSUBEFECMODIFICACION,
			'' AS EPPROYNOMB,
			'' AS AREANOMB,
			'' AS ULT_MEMORIA_CALCULO
			FROM
			EPR_SUBESTACION
			where EPSUBECODI = :Epsubecodi
		</query>
	</Sql>
	<Sql>
		<key>List</key>
		<query>
			WITH ULT_MC AS (
			SELECT AREACODI,MAX(EPSUBEFECHA) AS EPSUBEFECHA
			FROM EPR_SUBESTACION
			WHERE EPSUBEESTREGISTRO='1' GROUP BY AREACODI
			)
			SELECT
			SE.EPSUBECODI,
			SE.AREACODI,
			SE.EPPROYCODI,
			SE.EPSUBEMOTIVO,
			TO_CHAR(SE.EPSUBEFECHA, 'DD/MM/YYYY') AS EPSUBEFECHA,
			SE.EPSUBEFECHA AS EPSUBEFECHADATE,
			SE.EPSUBEMEMORIACALCULO,
			SE.EPSUBEESTREGISTRO,
			SE.EPSUBEUSUCREACION,
			SE.EPSUBEFECCREACION,
			SE.EPSUBEUSUMODIFICACION,
			SE.EPSUBEFECMODIFICACION,
			P.EPPROYNOMB,
			NVL(AP.EPAREANOMB,A.AREANOMB) AS AREANOMB,
			CASE WHEN UM.AREACODI IS NOT NULL THEN 'S' END AS ULT_MEMORIA_CALCULO
			FROM EPR_SUBESTACION SE
			INNER JOIN EPR_PROYECTO_ACTEQP P ON SE.EPPROYCODI = P.EPPROYCODI
			INNER JOIN EQ_AREA A ON SE.AREACODI = A.AREACODI
			INNER JOIN EPR_AREA AP ON A.AREACODI = AP.AREACODI AND AP.EPAREAESTREGISTRO='1'
			LEFT JOIN ULT_MC UM ON SE.AREACODI = UM.AREACODI AND SE.EPSUBEFECHA = UM.EPSUBEFECHA
			WHERE SE.EPSUBEESTREGISTRO ='1'
			AND (NVL(:AREACODI,0)=0 OR SE.AREACODI = :AREACODI)
			AND (NVL(:ZONACODI,0)=0 OR SE.AREACODI IN (SELECT AREACODI FROM EPR_AREA WHERE AREACODIZONA = :ZONACODI AND EPAREAESTREGISTRO='1'))
		</query>
	</Sql>
</Sqls>
