<?xml version="1.0" encoding="utf-8" ?>
<Sqls>
<Sql>
  <key>GetMaxId</key>
  <query>
    SELECT NVL(MAX(DATINSCODI),0) + 1 FROM GMM_DATINSUMO
  </query>
</Sql>
<Sql>
  <key>UpsertDatosInsumoTipoSC</key>
  <query>
    MERGE INTO GMM_DATINSUMO B
    USING (
    SELECT :EMPGCODI EMPGCODI, :DINSANIO DINSANIO, :DINSMES DINSMES, 'SC' TINSCODI
    FROM DUAL
    ) E
    ON (B.EMPGCODI = E.EMPGCODI AND B.DINSANIO = E.DINSANIO AND B.DINSMES = E.DINSMES AND B.TINSCODI = E.TINSCODI)
    WHEN MATCHED THEN
    UPDATE SET B.DINSVALOR = :DINSVALOR, DINSUSUMODIFICACION = :DINSUSUARIO, DINSFECMODIFICACION = SYSDATE
    WHEN NOT MATCHED THEN
    INSERT (DATINSCODI, DINSVALOR, EMPGCODI, PERICODI, TINSCODI, DINSANIO, DINSMES, DINSUSUCREACION, DINSFECCREACION)
    VALUES ((SELECT NVL(MAX(DATINSCODI),0) + 1 FROM GMM_DATINSUMO), :DINSVALOR, :EMPGCODI,
    (SELECT PERICODI FROM GMM_PERIODO WHERE PERIANIO = :DINSANIO AND PERIMES = :DINSMES),'SC', :DINSANIO, :DINSMES,
    :DINSUSUARIO, SYSDATE)
  </query>
</Sql>
  <Sql>
    <key>ListadoDatosInsumoTipoSC</key>
    <query>
      SELECT
      NVL(TRIM(NVL(SEMP.EMPRRAZSOCIAL,SEMP.EMPRNOMB)), ' - SIN RAZON SOCIAL - ') AS LISTEMPRNOMB,
      EMP.EMPGCODI AS LISTEMPGCODI,
      INSU.DINSVALOR AS LISTDINSVALOR
      FROM GMM_EMPRESA EMP
      LEFT JOIN GMM_DATINSUMO INSU ON EMP.EMPGCODI = INSU.EMPGCODI AND INSU.TINSCODI = 'SC'
      AND INSU.DINSANIO = {0} AND INSU.DINSMES = {1}
      JOIN SI_EMPRESA SEMP
      ON EMP.EMPRCODI = SEMP.EMPRCODI
      WHERE EMP.EMPGESTADO = 'H'
      ORDER BY NVL(TRIM(NVL(SEMP.EMPRRAZSOCIAL,SEMP.EMPRNOMB)), ' - SIN RAZON SOCIAL - ')
    </query>
  </Sql>
  <Sql>
    <key>ListadoDatosEntregas</key>
    <query>
      SELECT
      NVL(TRIM(NVL(SEMP.EMPRRAZSOCIAL,SEMP.EMPRNOMB)), ' - SIN RAZON SOCIAL - ') AS LISTEMPRNOMB,
      EMP.EMPGCODI AS LISTEMPGCODI,
      INSU.DINSVALOR AS LISTDINSVALOR
      FROM GMM_EMPRESA EMP
      LEFT JOIN GMM_DATINSUMO INSU ON EMP.EMPGCODI = INSU.EMPGCODI AND INSU.TINSCODI = 'ENTREGAS'
      AND INSU.DINSANIO = {0} AND INSU.DINSMES = {1}
      JOIN SI_EMPRESA SEMP
      ON EMP.EMPRCODI = SEMP.EMPRCODI
      WHERE EMP.EMPGESTADO = 'H' AND EMPGTIPOPART = 'G'
      ORDER BY NVL(TRIM(NVL(SEMP.EMPRRAZSOCIAL,SEMP.EMPRNOMB)), ' - SIN RAZON SOCIAL - ')
    </query>
  </Sql>
  <Sql>
    <key>UpsertDatosEntregas</key>
    <query>
      MERGE INTO GMM_DATINSUMO B
      USING (
      SELECT :EMPGCODI EMPGCODI, :DINSANIO DINSANIO, :DINSMES DINSMES, 'ENTREGAS' TINSCODI
      FROM DUAL
      ) E
      ON (B.EMPGCODI = E.EMPGCODI AND B.DINSANIO = E.DINSANIO AND B.DINSMES = E.DINSMES AND B.TINSCODI = E.TINSCODI)
      WHEN MATCHED THEN
      UPDATE SET B.DINSVALOR = :DINSVALOR, DINSUSUMODIFICACION = :DINSUSUARIO, DINSFECMODIFICACION = SYSDATE
      WHEN NOT MATCHED THEN
      INSERT (DATINSCODI, DINSVALOR, EMPGCODI, PERICODI, TINSCODI, DINSANIO, DINSMES, DINSUSUCREACION, DINSFECCREACION)
      VALUES ((SELECT NVL(MAX(DATINSCODI),0) + 1 FROM GMM_DATINSUMO), :DINSVALOR, :EMPGCODI,
      (SELECT PERICODI FROM GMM_PERIODO WHERE PERIANIO = :DINSANIO AND PERIMES = :DINSMES),'ENTREGAS', :DINSANIO, :DINSMES,
      :DINSUSUARIO, SYSDATE)
    </query>
  </Sql>
  <Sql>
    <key>ListadoDatosInflexibilidad</key>
    <query>
      SELECT
      NVL(TRIM(NVL(SEMP.EMPRRAZSOCIAL,SEMP.EMPRNOMB)), ' - SIN RAZON SOCIAL - ') AS LISTEMPRNOMB,
      EMP.EMPGCODI AS LISTEMPGCODI,
      INSU.DINSVALOR AS LISTDINSVALOR
      FROM GMM_EMPRESA EMP
      LEFT JOIN GMM_DATINSUMO INSU ON EMP.EMPGCODI = INSU.EMPGCODI AND INSU.TINSCODI = 'INFLEX'
      AND INSU.DINSANIO = {0} AND INSU.DINSMES = {1}
      JOIN SI_EMPRESA SEMP
      ON EMP.EMPRCODI = SEMP.EMPRCODI
      WHERE EMP.EMPGESTADO = 'H' 
      ORDER BY NVL(TRIM(NVL(SEMP.EMPRRAZSOCIAL,SEMP.EMPRNOMB)), ' - SIN RAZON SOCIAL - ')
    </query>
  </Sql>
  <Sql>
    <key>UpsertDatosInflexibilidad</key>
    <query>
      MERGE INTO GMM_DATINSUMO B
      USING (
      SELECT :EMPGCODI EMPGCODI, :DINSANIO DINSANIO, :DINSMES DINSMES, 'INFLEX' TINSCODI
      FROM DUAL
      ) E
      ON (B.EMPGCODI = E.EMPGCODI AND B.DINSANIO = E.DINSANIO AND B.DINSMES = E.DINSMES AND B.TINSCODI = E.TINSCODI)
      WHEN MATCHED THEN
      UPDATE SET B.DINSVALOR = :DINSVALOR, DINSUSUMODIFICACION = :DINSUSUARIO, DINSFECMODIFICACION = SYSDATE
      WHEN NOT MATCHED THEN
      INSERT (DATINSCODI, DINSVALOR, EMPGCODI, PERICODI, TINSCODI, DINSANIO, DINSMES, DINSUSUCREACION, DINSFECCREACION)
      VALUES ((SELECT NVL(MAX(DATINSCODI),0) + 1 FROM GMM_DATINSUMO), :DINSVALOR, :EMPGCODI,
      (SELECT PERICODI FROM GMM_PERIODO WHERE PERIANIO = :DINSANIO AND PERIMES = :DINSMES),'INFLEX', :DINSANIO, :DINSMES,
      :DINSUSUARIO, SYSDATE)
    </query>
  </Sql>
  <Sql>
    <key>ListadoDatosRecaudacion</key>
    <query>
      SELECT
      NVL(TRIM(NVL(SEMP.EMPRRAZSOCIAL,SEMP.EMPRNOMB)), ' - SIN RAZON SOCIAL - ') AS LISTEMPRNOMB,
      EMP.EMPGCODI AS LISTEMPGCODI,
      INSU.DINSVALOR AS LISTDINSVALOR
      FROM GMM_EMPRESA EMP
      LEFT JOIN GMM_DATINSUMO INSU ON EMP.EMPGCODI = INSU.EMPGCODI AND INSU.TINSCODI = 'RECAU'
      AND INSU.DINSANIO = {0} AND INSU.DINSMES = {1}
      JOIN SI_EMPRESA SEMP
      ON EMP.EMPRCODI = SEMP.EMPRCODI
      WHERE EMP.EMPGESTADO = 'H'
      ORDER BY NVL(TRIM(NVL(SEMP.EMPRRAZSOCIAL,SEMP.EMPRNOMB)), ' - SIN RAZON SOCIAL - ')
    </query>
  </Sql>
  <Sql>
    <key>UpsertDatosRecaudacion</key>
    <query>
      MERGE INTO GMM_DATINSUMO B
      USING (
      SELECT :EMPGCODI EMPGCODI, :DINSANIO DINSANIO, :DINSMES DINSMES, 'RECAU' TINSCODI
      FROM DUAL
      ) E
      ON (B.EMPGCODI = E.EMPGCODI AND B.DINSANIO = E.DINSANIO AND B.DINSMES = E.DINSMES AND B.TINSCODI = E.TINSCODI)
      WHEN MATCHED THEN
      UPDATE SET B.DINSVALOR = :DINSVALOR, DINSUSUMODIFICACION = :DINSUSUARIO, DINSFECMODIFICACION = SYSDATE
      WHEN NOT MATCHED THEN
      INSERT (DATINSCODI, DINSVALOR, EMPGCODI, PERICODI, TINSCODI, DINSANIO, DINSMES, DINSUSUCREACION, DINSFECCREACION)
      VALUES ((SELECT NVL(MAX(DATINSCODI),0) + 1 FROM GMM_DATINSUMO), :DINSVALOR, :EMPGCODI,
      (SELECT PERICODI FROM GMM_PERIODO WHERE PERIANIO = :DINSANIO AND PERIMES = :DINSMES),'RECAU', :DINSANIO, :DINSMES,
      :DINSUSUARIO, SYSDATE)
    </query>
  </Sql>
  <Sql>
    <key>ListadoInsumosBk</key>
    <query>
      SELECT
      EMP.EMPGCODI AS LISTEMPGCODI,
      NVL(TRIM(NVL(SEMP.EMPRRAZSOCIAL,SEMP.EMPRNOMB)), ' - SIN RAZON SOCIAL - ') AS LISTEMPRNOMB,
      (SELECT DINSVALOR FROM GMM_DATINSUMO
      WHERE EMPGCODI = EMP.EMPGCODI  AND TINSCODI = 'ENTREGAS'
      AND DINSANIO = {0} AND DINSMES = {1}) AS ENTREGAS,
      (SELECT DINSVALOR FROM GMM_DATINSUMO
      WHERE EMPGCODI = EMP.EMPGCODI  AND TINSCODI = 'SC'
      AND DINSANIO = {0} AND DINSMES = {1}) AS SC,
      (SELECT DINSVALOR FROM GMM_DATINSUMO
      WHERE EMPGCODI = EMP.EMPGCODI  AND TINSCODI = 'INFLEX'
      AND DINSANIO = {0} AND DINSMES = {1}) AS INFLEX,
      (SELECT DINSVALOR FROM GMM_DATINSUMO
      WHERE EMPGCODI = EMP.EMPGCODI  AND TINSCODI = 'RECAU'
      AND DINSANIO = {0} AND DINSMES = {1}) AS RECAU
      FROM GMM_EMPRESA EMP JOIN SI_EMPRESA SEMP ON EMP.EMPRCODI = SEMP.EMPRCODI AND EMP.EMPGESTADO = 'H'
      ORDER BY NVL(TRIM(NVL(SEMP.EMPRRAZSOCIAL,SEMP.EMPRNOMB)), ' - SIN RAZON SOCIAL - ')
    </query>
  </Sql>
  <Sql>
    <key>ListadoInsumos</key>
    <query>
      SELECT distinct
      EMP.EMPGCODI AS LISTEMPGCODI,
      --cal.dcalcodi,
      NVL(TRIM(NVL(SEMP.EMPRRAZSOCIAL,SEMP.EMPRNOMB)), ' - SIN RAZON SOCIAL - ') AS LISTEMPRNOMB,
      DAT1.DINSVALOR AS ENTREGAS,
      DAT2.DINSVALOR AS SC,
      DAT3.DINSVALOR AS INFLEX,
      DAT4.DINSVALOR AS RECAU
      FROM GMM_EMPRESA EMP
      LEFT JOIN GMM_DATCALCULO CAL ON CAL.EMPGCODI=EMP.EMPGCODI  AND CAL.TINSCODI !='DCP' AND  CAL.DATCALESTADO = '1'  -- AND DAT2.EMPGCODI = CAL.EMPGCODI AND DAT3.EMPGCODI = CAL.EMPGCODI AND DAT4.EMPGCODI = CAL.EMPGCODI AND CAL.TINSCODI !='DCP'
      INNER JOIN GMM_PERIODO PER ON PER.PERICODI=CAL.PERICODI --AND  CAL.DCALANIO = '2021' AND CAL.DCALMES = '12'
      LEFT JOIN GMM_DATINSUMO  DAT1 ON DAT1.EMPGCODI = EMP.EMPGCODI  AND DAT1.TINSCODI = 'ENTREGAS' AND  DAT1.DINSANIO = {0} AND DAT1.DINSMES = {1}
      LEFT JOIN GMM_DATINSUMO  DAT2 ON DAT2.EMPGCODI = EMP.EMPGCODI  AND DAT2.TINSCODI = 'SC' AND  DAT2.DINSANIO = {0} AND DAT2.DINSMES = {1}
      LEFT JOIN GMM_DATINSUMO  DAT3 ON DAT3.EMPGCODI = EMP.EMPGCODI  AND DAT3.TINSCODI = 'INFLEX' AND  DAT3.DINSANIO = {0} AND DAT3.DINSMES = {1}
      LEFT JOIN GMM_DATINSUMO  DAT4 ON DAT4.EMPGCODI = EMP.EMPGCODI  AND DAT4.TINSCODI = 'RECAU' AND  DAT4.DINSANIO = {0} AND DAT4.DINSMES = {1}
      JOIN SI_EMPRESA SEMP ON EMP.EMPRCODI = SEMP.EMPRCODI AND EMP.EMPGESTADO = 'H'
      WHERE PER.PERICODI &lt;  (SELECT PERICODI from GMM_PERIODO X
                      WHERE X.PERIANIO = {0}
                       AND X.PERIMES= {1} )
      /*WHERE  cal.dcalcodi IS not NULL
      ORDER BY NVL(TRIM(NVL(SEMP.EMPRRAZSOCIAL,SEMP.EMPRNOMB)), ' - SIN RAZON SOCIAL - ')
      */
      ORDER BY 1 asc
    </query>
  </Sql>
</Sqls>