<?xml version="1.0" encoding="utf-8" ?>
<Sqls>


  <Sql>
    <key>DeleteCompensacionManual</key>
    <query>
      DELETE FROM VCE_COMP_MME_DET_MANUAL WHERE pecacodi = {0} AND grupocodi = {1} AND TO_CHAR(CMMEDMHORA, 'dd/mm/yyyy HH24:MI:SS') = '{2}'
    </query>
  </Sql>

  <Sql>
    <key>DeleteCompensacionManualByVersion</key>
    <query>
      DELETE FROM VCE_COMP_MME_DET_MANUAL WHERE PECACODI = :PECACODI
    </query>
  </Sql>

  <Sql>
    <key>UpdateCompensacionRegular</key>
    <query>
      UPDATE VCE_COMP_REGULAR_DET SET CRDETTIPOCALC = '' WHERE pecacodi = {0} AND grupocodi = {1} AND TO_CHAR(CRDETHORA, 'dd/mm/yyyy HH24:MI:SS') = '{2}' AND CRDETTIPOCALC = 'M'
    </query>
  </Sql>

  <Sql>
    <key>UpdateCompensacionRegularlByVersion</key>
    <query>
      UPDATE VCE_COMP_REGULAR_DET SET CRDETTIPOCALC = '' WHERE PECACODI = :PECACODI AND CRDETTIPOCALC = 'M'
    </query>
  </Sql>
  
  
  <Sql>
    <key>SaveManual</key>
    <query>
      INSERT INTO VCE_COMP_MME_DET_MANUAL(
      SUBCAUSACODI,
      CMMEDMENERGIA,
      CMMEDMPOTENCIA ,
      CMMEDMCONSUMOCOMB,
      CMMEDMPRECIOAPLIC,
      CMMEDMCVC,
      CMMEDMCVNC,
      CMMEDMCVT,
      CMMEDMCMG,
      CMMEDMCOMPENSACION,
      CMMEDMTIPOCALC,
      PECACODI,
      GRUPOCODI,
      CMMEDMHORA
      )
      VALUES (
      :SUBCAUSACODI,
      :CMMEDMENERGIA,
      :CMMEDMPOTENCIA ,
      :CMMEDMCONSUMOCOMB,
      :CMMEDMPRECIOAPLIC,
      :CMMEDMCVC,
      :CMMEDMCVNC,
      :CMMEDMCVT,
      :CMMEDMCMG,
      :CMMEDMCOMPENSACION,
      :CMMEDMTIPOCALC,
      :PECACODI,
      :GRUPOCODI,
      TO_DATE(:CMMEDMHORA,'FXDD/MM/YYYY FXHH24:MI:SS')
      )
    </query>
  </Sql>
  
  <Sql>
    <key>UpdateCompensacionDet</key>
    <query>
      UPDATE VCE_COMP_REGULAR_DET SET (CRDETTIPOCALC,SUBCAUSACODI,CRDETVALOR,CRDETPOTENCIA,CRDETCONSUMOCOMB,CRDETPRECIOAPLIC,CRDETCMG,CRDETCVC,CRDETCVNC,CRDETCVT,CRDETCOMPENSACION)
      =(SELECT 'M',SUBCAUSACODI,CMMEDMENERGIA,CMMEDMPOTENCIA,CMMEDMCONSUMOCOMB,CMMEDMPRECIOAPLIC,CMMEDMCMG,CMMEDMCVC,CMMEDMCVNC,CMMEDMCVT,CMMEDMCOMPENSACION FROM VCE_COMP_MME_DET_MANUAL MME
      WHERE MME.PECACODI = VCE_COMP_REGULAR_DET.PECACODI AND MME.GRUPOCODI = VCE_COMP_REGULAR_DET.GRUPOCODI AND MME.CMMEDMHORA = VCE_COMP_REGULAR_DET.CRDETHORA AND MME.PECACODI = {0} )
      WHERE EXISTS (SELECT 1 FROM VCE_COMP_MME_DET_MANUAL MME
      WHERE MME.PECACODI = VCE_COMP_REGULAR_DET.PECACODI AND MME.GRUPOCODI = VCE_COMP_REGULAR_DET.GRUPOCODI AND MME.CMMEDMHORA = VCE_COMP_REGULAR_DET.CRDETHORA AND MME.PECACODI = {0} )

    </query>
  </Sql>
  
  <Sql>
    <key>SaveCompensacionDet</key>
    <query>
      INSERT INTO VCE_COMP_REGULAR_DET (PECACODI,GRUPOCODI,CRDETHORA,CRDETTIPOCALC,SUBCAUSACODI,CRDETVALOR,CRDETPOTENCIA,CRDETCONSUMOCOMB,CRDETPRECIOAPLIC,CRDETCMG,CRDETCVC,CRDETCVNC,CRDETCVT,CRDETCOMPENSACION)
      SELECT PECACODI,GRUPOCODI,CMMEDMHORA,'M',SUBCAUSACODI,CMMEDMENERGIA,CMMEDMPOTENCIA,CMMEDMCONSUMOCOMB,CMMEDMPRECIOAPLIC,CMMEDMCMG,CMMEDMCVC,CMMEDMCVNC,CMMEDMCVT,CMMEDMCOMPENSACION
      FROM VCE_COMP_MME_DET_MANUAL MAN
      WHERE MAN.PECACODI = {0} AND NOT EXISTS (SELECT 1 FROM VCE_COMP_MME_DET_MANUAL MME
      WHERE MME.PECACODI = MAN.PECACODI AND MME.GRUPOCODI = MAN.GRUPOCODI AND MME.CMMEDMHORA = MAN.CMMEDMHORA AND MME.PECACODI = {0} )


    </query>
  </Sql>

  <Sql>
    <key>ListCompensacionManual</key>
    <query>
      SELECT (CASE WHEN EQ.EMPRCODI IS NULL  THEN '_NO DEFINIDO' ELSE EMP.EMPRNOMB END) AS EMPRNOMB,
      OP.SUBCAUSADESC, TRIM(MO.GRUPONOMB) AS GRUPONOMB,
      BE.PECACODI,BE.GRUPOCODI,CMMEDMHORA,BE.SUBCAUSACODI,CMMEDMENERGIA,CMMEDMPOTENCIA,CMMEDMCONSUMOCOMB,CMMEDMPRECIOAPLIC,
      CMMEDMCVC,CMMEDMCVNC,CMMEDMCVT,CMMEDMCMG,CMMEDMCOMPENSACION, CMMEDMTIPOCALC
      FROM VCE_COMP_MME_DET_MANUAL BE
      JOIN PR_GRUPO MO ON BE.GRUPOCODI = MO.GRUPOCODI
      JOIN PR_GRUPO GG ON MO.GRUPOPADRE = GG.GRUPOCODI
      LEFT JOIN
      (SELECT GRUPOCODI, EMPRCODI, MAX(EQUIPADRE) EQUIPADRE
      FROM EQ_EQUIPO
      WHERE FAMCODI IN (2,3) AND NVL(GRUPOCODI,-1) != -1  AND EQUIESTADO = 'A'
      GROUP BY GRUPOCODI, EMPRCODI
      UNION
      SELECT GRUPOCODI, EMPRCODI, MAX(EQUIPADRE) EQUIPADRE
      FROM EQ_EQUIPO
      WHERE FAMCODI IN (2,3) AND NVL(GRUPOCODI,-1) != -1  AND EQUIESTADO = 'B'
      AND GRUPOCODI NOT IN (SELECT DISTINCT GRUPOCODI
      FROM EQ_EQUIPO
      WHERE FAMCODI IN (2,3) AND NVL(GRUPOCODI,-1) != -1 AND EQUIESTADO = 'A' )
      GROUP BY GRUPOCODI, EMPRCODI
      )EQ ON MO.GRUPOPADRE = EQ.GRUPOCODI
      LEFT JOIN EQ_EQUIPO CG ON  EQ.EQUIPADRE = CG.EQUICODI -- CENTRAL
      LEFT JOIN SI_EMPRESA EMP ON EQ.EMPRCODI = EMP.EMPRCODI
      JOIN EVE_SUBCAUSAEVENTO OP ON BE.SUBCAUSACODI = OP.SUBCAUSACODI
      WHERE BE.PECACODI = {0} AND BE.GRUPOCODI NOT IN (263,264)
       {1}     
      ORDER BY OP.SUBCAUSADESC, MO.GRUPONOMB, BE.CMMEDMHORA

    </query>
  </Sql>  


</Sqls>

