<?xml version="1.0" encoding="utf-8" ?>
<Sqls>

  <Sql>
    <key>Save</key>
    <query>
      insert into vce_comp_regular_det(
      crdettipocalc,
      crdetcvtbajaefic,
      crdetcompensacion,
      crdetcmg,
      crdetcvt,
      subcausacodi,
      crdetvalor,
      crdethora,
      grupocodi,
      pecacodi
      )
      values(
      :crdettipocalc,
      :crdetcvtbajaefic,
      :crdetcompensacion,
      :crdetcmg,
      :crdetcvt,
      :subcausacodi,
      :crdetvalor,
      :crdethora,
      :grupocodi,
      :pecacodi
      )
    </query>
  </Sql>

  <Sql>
    <key>Update</key>
    <query>
      update vce_comp_regular_det
      set
      crdettipocalc = :crdettipocalc,
      crdetcvtbajaefic = :crdetcvtbajaefic,
      crdetcompensacion = :crdetcompensacion,
      crdetcmg = :crdetcmg,
      crdetcvt = :crdetcvt,
      subcausacodi = :subcausacodi,
      crdetvalor = :crdetvalor
      where
      crdethora = :crdethora and
      grupocodi = :grupocodi and
      pecacodi = :pecacodi
    </query>
  </Sql>

  <Sql>
    <key>Delete</key>
    <query>
      delete from vce_comp_regular_det
      where
      crdethora = :crdethora and
      grupocodi = :grupocodi and
      pecacodi = :pecacodi
    </query>
  </Sql>

  <Sql>
    <key>DeleteByGroup</key>
    <query>
      delete from vce_comp_regular_det
      where exists (select 1 from vce_comp_bajaefic cbe
      where vce_comp_regular_det.pecacodi = cbe.pecacodi
      and vce_comp_regular_det.grupocodi = cbe.grupocodi
      and vce_comp_regular_det.crdethora between cbe.crcbehorini and cbe.crcbehorfin
      and cbe.pecacodi = :pecacodi
      and cbe.grupocodi = :grupocodi
      and cbe.subcausacodi = :subcausacodi
      and cbe.crcbehorini = :crbehorini
      and cbe.crcbehorfin = :crcbehorfin)
    </query>
  </Sql>

  <Sql>
    <key>GetById</key>
    <query>
      select
      crdettipocalc,
      crdetcvtbajaefic,
      crdetcompensacion,
      crdetcmg,
      crdetcvt,
      subcausacodi,
      crdetvalor,
      crdethora,
      grupocodi,
      pecacodi
      from
      vce_comp_regular_det
      where
      crdethora = :crdethora and
      grupocodi = :grupocodi and
      pecacodi = :pecacodi
    </query>
  </Sql>

  <Sql>
    <key>List</key>
    <query>
      select
      crdettipocalc,
      crdetcvtbajaefic,
      crdetcompensacion,
      crdetcmg,
      crdetcvt,
      subcausacodi,
      crdetvalor,
      crdethora,
      grupocodi,
      pecacodi
      from
      vce_comp_regular_det
    </query>
  </Sql>

  <Sql>
    <key>GetByCriteria</key>
    <query>
      select
      crdettipocalc,
      crdetcvtbajaefic,
      crdetcompensacion,
      crdetcmg,
      crdetcvt,
      subcausacodi,
      crdetvalor,
      crdethora,
      grupocodi,
      pecacodi
      from
      vce_comp_regular_det
    </query>
  </Sql>

  <!--NETC-->
  <!-- VERSION 03 -->
  <Sql>
    <key>ListCompensacionesEspeciales</key>
    <query>
      SELECT (CASE WHEN EQ.EMPRCODI IS NULL  THEN '_NO DEFINIDO' ELSE EMP.EMPRNOMB END) AS EMPRNOMB,
      TRIM(MO.GRUPONOMB) AS GRUPONOMB, CE.CRDETCOMPENSACION, CE.GRUPOCODI
      FROM
      (SELECT CE.PECACODI, CE.GRUPOCODI, ROUND(SUM(CE.CRDETCOMPENSACION),2) AS CRDETCOMPENSACION
      FROM VCE_COMP_REGULAR_DET CE
      WHERE CE.PECACODI = {0}  AND CE.SUBCAUSACODI != 106 AND CE.SUBCAUSACODI != 122
      GROUP BY CE.PECACODI, CE.GRUPOCODI
      )CE
      INNER JOIN PR_GRUPO MO ON CE.GRUPOCODI = MO.GRUPOCODI
      INNER JOIN PR_GRUPO GG ON MO.GRUPOPADRE = GG.GRUPOCODI
      LEFT JOIN
      (SELECT GRUPOCODI, EMPRCODI, MAX(EQUIPADRE) EQUIPADRE
      FROM EQ_EQUIPO
      WHERE FAMCODI IN (2,3) AND NVL(GRUPOCODI,-1) != -1  AND EQUIESTADO = 'A'
      GROUP BY GRUPOCODI, EMPRCODI
      UNION
      SELECT GRUPOCODI, EMPRCODI, MAX(EQUIPADRE) EQUIPADRE
      FROM EQ_EQUIPO
      WHERE FAMCODI IN (2,3) AND NVL(GRUPOCODI,-1) != -1  AND EQUIESTADO = 'B'
      AND GRUPOCODI NOT IN (SELECT DISTINCT GRUPOCODI
      FROM EQ_EQUIPO
      WHERE FAMCODI IN (2,3) AND NVL(GRUPOCODI,-1) != -1 AND EQUIESTADO = 'A' )
      GROUP BY GRUPOCODI, EMPRCODI
      )EQ ON MO.GRUPOPADRE = EQ.GRUPOCODI
      LEFT JOIN EQ_EQUIPO CG ON  EQ.EQUIPADRE = CG.EQUICODI -- CENTRAL
      LEFT JOIN SI_EMPRESA EMP ON EQ.EMPRCODI = EMP.EMPRCODI
      WHERE PECACODI = {0}
      {1}
      ORDER BY 2
    </query>
  </Sql>
  
  <Sql>
    <key>ListFechaMod</key>
    <query>
      SELECT DISTINCT CRCVFECMOD
      FROM VCE_COSTO_VARIABLE
      WHERE pecacodi = {0} AND grupocodi = {1}
      ORDER BY 1
    </query>
  </Sql>

  <Sql>
    <key>DeleteCompensacionManual</key>
    <query>
      DELETE FROM VCE_COMP_REGULAR_DET WHERE pecacodi = {0} AND grupocodi = {1} AND CRDETHORA = TO_DATE('{2}','DD/MM/YYYY HH24:MI:SS')
    </query>
  </Sql>

  <Sql>
    <key>SaveManual</key>
    <query>
      INSERT INTO VCE_COMP_REGULAR_DET(
      pecacodi,
      GRUPOCODI,
      CRDETHORA,
      CRDETVALOR,
      SUBCAUSACODI,
      CRDETCVT,
      CRDETCMG,
      CRDETCOMPENSACION,
      CRDETCVTBAJAEFIC,
      CRDETTIPOCALC
      )
      VALUES(
      :pecacodi,
      :GRUPOCODI,
      :CRDETHORA,
      :CRDETVALOR,
      :SUBCAUSACODI,
      :CRDETCVT,
      :CRDETCMG,
      :CRDETCOMPENSACION,
      :CRDETCVTBAJAEFIC,
      :CRDETTIPOCALC
      )
    </query>
  </Sql>

  <Sql>
    <key>ListCursorHoraOperacionComun</key>
    <query>
      SELECT 15-TRUNC((CRHOPHORFINAJUST_1-CRHOPHORFIN_1)*24*60) AS DELTA_1
      ,TRUNC((CRHOPHORINIAJUST_2-CRHOPHORINI_2)*24*60) AS DELTA_2
      ,RES.GRUPOCODI, TO_CHAR(RES.CRHOPHORFINAJUST_1, 'DD/MM/YYYY HH24:MI:SS') AS RANGO_HORA
      ,CASE WHEN (15-TRUNC((CRHOPHORFINAJUST_1-CRHOPHORFIN_1)*24*60)) > TRUNC((CRHOPHORINIAJUST_2-CRHOPHORINI_2)*24*60) THEN SUBCAUSACODI_1 ELSE SUBCAUSACODI_2 END RANGO_SUBCAUSACODI
      FROM (
      SELECT R1.HOPCODI,R1.GRUPOCODI
      ,R1.CRHOPHORINI AS CRHOPHORINI_1
      ,R1.CRHOPHORFIN AS CRHOPHORFIN_1,R1.SUBCAUSACODI AS SUBCAUSACODI_1
      --,VCE_COMPENSACION_PKG.FNC_OBTIENE_INTERVALO_15MIN(R1.CRHOPHORINI) CRHOPHORINIAJUST_1
      ,(TO_DATE(TO_CHAR(R1.CRHOPHORINI,'YYYY-MM-DD HH24'),'YYYY-MM-DD HH24') +
      (CASE WHEN TO_CHAR(R1.CRHOPHORINI,'MI') BETWEEN 0 AND 15 THEN 1
      WHEN TO_CHAR(R1.CRHOPHORINI,'MI') &gt; 15 AND TO_CHAR(R1.CRHOPHORINI,'MI') &lt;= 30 THEN 2
      WHEN TO_CHAR(R1.CRHOPHORINI,'MI') &gt; 30 AND TO_CHAR(R1.CRHOPHORINI,'MI') &lt;= 45 THEN 3
      WHEN TO_CHAR(R1.CRHOPHORINI,'MI') &gt; 45 AND TO_CHAR(R1.CRHOPHORINI,'MI') &lt; 60 THEN 4
      END) *1/24/4) CRHOPHORINIAJUST_1
      --,VCE_COMPENSACION_PKG.FNC_OBTIENE_INTERVALO_15MIN(R1.CRHOPHORFIN) CRHOPHORFINAJUST_1
      ,(TO_DATE(TO_CHAR(R1.CRHOPHORFIN,'YYYY-MM-DD HH24'),'YYYY-MM-DD HH24') +
      (CASE WHEN TO_CHAR(R1.CRHOPHORFIN,'MI') BETWEEN 0 AND 15 THEN 1
      WHEN TO_CHAR(R1.CRHOPHORFIN,'MI') &gt; 15 AND TO_CHAR(R1.CRHOPHORFIN,'MI') &lt;= 30 THEN 2
      WHEN TO_CHAR(R1.CRHOPHORFIN,'MI') &gt; 30 AND TO_CHAR(R1.CRHOPHORFIN,'MI') &lt;= 45 THEN 3
      WHEN TO_CHAR(R1.CRHOPHORFIN,'MI') &gt; 45 AND TO_CHAR(R1.CRHOPHORFIN,'MI') &lt; 60 THEN 4
      END) *1/24/4) CRHOPHORFINAJUST_1
      ,R2.CRHOPHORINI AS CRHOPHORINI_2
      ,R2.CRHOPHORFIN AS CRHOPHORFIN_2
      ,R2.SUBCAUSACODI AS SUBCAUSACODI_2
      --,VCE_COMPENSACION_PKG.FNC_OBTIENE_INTERVALO_15MIN(R2.CRHOPHORINI) CRHOPHORINIAJUST_2
      ,(TO_DATE(TO_CHAR(R2.CRHOPHORINI,'YYYY-MM-DD HH24'),'YYYY-MM-DD HH24') +
      (CASE WHEN TO_CHAR(R2.CRHOPHORINI,'MI') BETWEEN 0 AND 15 THEN 1
      WHEN TO_CHAR(R2.CRHOPHORINI,'MI') &gt; 15 AND TO_CHAR(R2.CRHOPHORINI,'MI') &lt;= 30 THEN 2
      WHEN TO_CHAR(R2.CRHOPHORINI,'MI') &gt; 30 AND TO_CHAR(R2.CRHOPHORINI,'MI') &lt;= 45 THEN 3
      WHEN TO_CHAR(R2.CRHOPHORINI,'MI') &gt; 45 AND TO_CHAR(R2.CRHOPHORINI,'MI') &lt; 60 THEN 4
      END) *1/24/4) CRHOPHORINIAJUST_2
      --,VCE_COMPENSACION_PKG.FNC_OBTIENE_INTERVALO_15MIN(R2.CRHOPHORFIN) CRHOPHORFINAJUST_2
      ,(TO_DATE(TO_CHAR(R2.CRHOPHORFIN,'YYYY-MM-DD HH24'),'YYYY-MM-DD HH24') +
      (CASE WHEN TO_CHAR(R2.CRHOPHORFIN,'MI') BETWEEN 0 AND 15 THEN 1
      WHEN TO_CHAR(R2.CRHOPHORFIN,'MI') &gt; 15 AND TO_CHAR(R2.CRHOPHORFIN,'MI') &lt;= 30 THEN 2
      WHEN TO_CHAR(R2.CRHOPHORFIN,'MI') &gt; 30 AND TO_CHAR(R2.CRHOPHORFIN,'MI') &lt;= 45 THEN 3
      WHEN TO_CHAR(R2.CRHOPHORFIN,'MI') &gt; 45 AND TO_CHAR(R2.CRHOPHORFIN,'MI') &lt; 60 THEN 4
      END) *1/24/4) CRHOPHORFINAJUST_2
      FROM (SELECT ROWNUM SEC,T.*
      FROM (SELECT HOPCODI,GRUPOCODI,CRHOPHORINI,CRHOPHORFIN,SUBCAUSACODI FROM VCE_HORA_OPERACION WHERE pecacodi = {0}  ORDER BY GRUPOCODI,CRHOPHORINI) T) R1
      LEFT JOIN (SELECT ROWNUM SEC,T.*
      FROM (SELECT HOPCODI,GRUPOCODI,CRHOPHORINI,CRHOPHORFIN,SUBCAUSACODI FROM VCE_HORA_OPERACION WHERE pecacodi = {0} ORDER BY GRUPOCODI,CRHOPHORINI) T) R2
      ON R1.GRUPOCODI = R2.GRUPOCODI AND (R1.SEC + 1) = R2.SEC
      ORDER BY R1.CRHOPHORINI) RES
      WHERE CRHOPHORFINAJUST_1 = CRHOPHORINIAJUST_2
      ORDER BY 1
    </query>
  </Sql>

  <Sql>
    <key>ListCursorGrupoComun</key>
    <query>
      SELECT DISTINCT GRUPOCODI FROM TMP_GRUPOREL ORDER BY 1
    </query>
  </Sql>

  <Sql>
    <key>ListCursorFechasComun</key>
    <query>
      SELECT TO_CHAR(CRDETHORA, 'DD/MM/YYYY HH24:MI:SS') AS CRDETHORA,COUNT(DISTINCT GRUPOCODI) AS CANT FROM VCE_COMP_REGULAR_DET
      WHERE pecacodi = {0}
      AND SUBCAUSACODI IS NOT NULL
      AND (GRUPOCODI = {1} OR GRUPOCODI IN (SELECT GRUPOCODIREL FROM TMP_GRUPOREL WHERE GRUPOCODI = {1} ))
      GROUP BY CRDETHORA
      HAVING COUNT(DISTINCT GRUPOCODI) >1
      ORDER BY CRDETHORA
    </query>
  </Sql>

  <!-- DSH : Se cambio por requerimiento-->
  <!-- SELECT GRUPOCODI,VCE_COMPENSACION_PKG.FNC_PARTICIPA_INTERVALO_15MIN(TO_DATE('{2}','DD/MM/YYYY HH24:MI:SS') ,CRHOPHORINI,CRHOPHORFIN) AS PARTICIPACION -->
  <Sql>
    <key>ListCursorParticipacionComun</key>
    <query>
      SELECT GRUPOCODI,
      (CASE WHEN TO_DATE('{2}','DD/MM/YYYY HH24:MI:SS') BETWEEN CRHOPHORINI AND CRHOPHORFIN THEN
      CASE WHEN ((TO_DATE('{2}','DD/MM/YYYY HH24:MI:SS') - CRHOPHORINI)*24*60)>15
      THEN 15
      ELSE ((TO_DATE('{2}','DD/MM/YYYY HH24:MI:SS') - CRHOPHORINI)*24*60) END
      WHEN (TO_DATE('{2}','DD/MM/YYYY HH24:MI:SS') - 1/24/4) BETWEEN CRHOPHORINI AND CRHOPHORFIN THEN
      CASE WHEN (15 + (CRHOPHORFIN - TO_DATE('{2}','DD/MM/YYYY HH24:MI:SS'))*24*60)> 15
      THEN 15
      ELSE (15 + (CRHOPHORFIN - TO_DATE('{2}','DD/MM/YYYY HH24:MI:SS'))*24*60) END
      ELSE
      (CRHOPHORFIN - CRHOPHORINI)*24*60
      END) PARTICIPACION
      FROM VCE_HORA_OPERACION
      WHERE pecacodi = {0} AND SUBCAUSACODI != 106 AND SUBCAUSACODI != 122
      AND (GRUPOCODI = {1} OR GRUPOCODI IN (SELECT GRUPOCODIREL FROM TMP_GRUPOREL WHERE GRUPOCODI = {1} ))
      AND (TO_DATE('{2}','DD/MM/YYYY HH24:MI:SS') BETWEEN CRHOPHORINI AND CRHOPHORFIN
      OR (TO_DATE('{2}','DD/MM/YYYY HH24:MI:SS') - 1/24/4) BETWEEN CRHOPHORINI AND CRHOPHORFIN
      OR CRHOPHORINI  BETWEEN (TO_DATE('{2}','DD/MM/YYYY HH24:MI:SS') - 1/24/4) AND TO_DATE('{2}','DD/MM/YYYY HH24:MI:SS')
      OR CRHOPHORFIN  BETWEEN (TO_DATE('{2}','DD/MM/YYYY HH24:MI:SS') - 1/24/4) AND TO_DATE('{2}','DD/MM/YYYY HH24:MI:SS')
      )
      ORDER BY 2 DESC
    </query>
  </Sql>

  <Sql>
    <key>DeleteByVersion</key>
    <query>
      DELETE FROM VCE_COMP_REGULAR_DET WHERE pecacodi = {0}
    </query>
  </Sql>

  <Sql>
    <key>DeleteByVersionTipoCalculoAutomatico</key>
    <query>
      DELETE FROM VCE_COMP_REGULAR_DET WHERE pecacodi = {0} AND  CRDETTIPOCALC IS NULL OR CRDETTIPOCALC != 'M'
    </query>
  </Sql>

  <Sql>
    <key>SaveFromOtherVersion</key>
    <query>
      INSERT INTO VCE_COMP_REGULAR_DET(
      PECACODI, GRUPOCODI, CRDETHORA, CRDETVALOR, SUBCAUSACODI, CRDETCVT,
      CRDETCMG, CRDETCOMPENSACION, CRDETCVTBAJAEFIC,CRDETTIPOCALC
      )
      SELECT {0}, GRUPOCODI, CRDETHORA, CRDETVALOR, SUBCAUSACODI,CRDETCVT,
      CRDETCMG, CRDETCOMPENSACION, CRDETCVTBAJAEFIC, CRDETTIPOCALC
      FROM VCE_COMP_REGULAR_DET
      WHERE PECACODI = {1}
    </query>
  </Sql>


  <Sql>
    <key>ActualizarPotencia</key>
    <query>
      UPDATE VCE_COMP_REGULAR_DET SET CRDETPOTENCIA =  CRDETVALOR*4 WHERE PECACODI = {0} AND CRDETVALOR IS NOT NULL
    </query>
  </Sql>

  <Sql>
    <key>ActualizarPotenciaMinima</key>
    <query>
      UPDATE VCE_COMP_REGULAR_DET SET CRDETPOTENCIA =  (SELECT CRDCGPOTMIN FROM VCE_DATCALCULO DC
      WHERE DC.PECACODI = VCE_COMP_REGULAR_DET.PECACODI AND DC.GRUPOCODI = VCE_COMP_REGULAR_DET.GRUPOCODI AND DC.CRDCGFECMOD = TO_DATE('{2}','DD/MM/YYYY'))
      WHERE PECACODI = {0} AND GRUPOCODI = {1} AND CRDETHORA >= TO_DATE('{2}','DD/MM/YYYY') {3} AND CRDETPOTENCIA IS NOT NULL
      AND EXISTS (SELECT 1 FROM VCE_DATCALCULO DC
      WHERE DC.PECACODI = VCE_COMP_REGULAR_DET.PECACODI AND DC.GRUPOCODI = VCE_COMP_REGULAR_DET.GRUPOCODI AND DC.CRDCGFECMOD = TO_DATE('{2}','DD/MM/YYYY')
      AND NVL(VCE_COMP_REGULAR_DET.CRDETPOTENCIA,0) &lt; NVL(DC.CRDCGPOTMIN,0))
    </query>
  </Sql>

  <Sql>
    <key>ActualizarPotenciaMaxima</key>
    <query>
      UPDATE VCE_COMP_REGULAR_DET SET CRDETPOTENCIA =  (SELECT CRDCGPOTEFE FROM VCE_DATCALCULO DC
      WHERE DC.PECACODI = VCE_COMP_REGULAR_DET.PECACODI AND DC.GRUPOCODI = VCE_COMP_REGULAR_DET.GRUPOCODI AND DC.CRDCGFECMOD = TO_DATE('{2}','DD/MM/YYYY'))
      WHERE PECACODI = {0} AND GRUPOCODI = {1}  AND CRDETHORA >= TO_DATE('{2}','DD/MM/YYYY') {3} AND CRDETPOTENCIA IS NOT NULL
      AND EXISTS (SELECT 1 FROM VCE_DATCALCULO DC
      WHERE DC.PECACODI = VCE_COMP_REGULAR_DET.PECACODI AND DC.GRUPOCODI = VCE_COMP_REGULAR_DET.GRUPOCODI AND DC.CRDCGFECMOD = TO_DATE('{2}','DD/MM/YYYY')
      AND NVL(VCE_COMP_REGULAR_DET.CRDETPOTENCIA,0) > NVL(DC.CRDCGPOTEFE,0))
    </query>
  </Sql>

  <Sql>
    <key>ActualizarConsumoCombustible</key>
    <query>
      UPDATE VCE_COMP_REGULAR_DET SET CRDETCONSUMOCOMB =  (SELECT CASE
      WHEN ROUND(VCE_COMP_REGULAR_DET.CRDETPOTENCIA,2) = ROUND(V_P1,2) THEN V_CON1
      WHEN (NVL(V_P2,0) > 0 AND (V_P2 &lt; VCE_COMP_REGULAR_DET.CRDETPOTENCIA) AND (VCE_COMP_REGULAR_DET.CRDETPOTENCIA &lt;= V_P1))
      THEN V_CON2 + (VCE_COMP_REGULAR_DET.CRDETPOTENCIA - V_P2) * (V_CON1 - V_CON2) / (V_P1 - V_P2)
      WHEN (NVL(V_P3,0) > 0 AND (V_P3 &lt; VCE_COMP_REGULAR_DET.CRDETPOTENCIA) AND (VCE_COMP_REGULAR_DET.CRDETPOTENCIA &lt;= V_P2))
      THEN V_CON3 + (VCE_COMP_REGULAR_DET.CRDETPOTENCIA - V_P3) * (V_CON2 - V_CON3) / (V_P2 - V_P3)
      WHEN (NVL(V_P4,0) > 0 AND (V_P4 &lt; VCE_COMP_REGULAR_DET.CRDETPOTENCIA) AND (VCE_COMP_REGULAR_DET.CRDETPOTENCIA &lt;= V_P3))
      THEN V_CON4 + (VCE_COMP_REGULAR_DET.CRDETPOTENCIA - V_P4) * (V_CON3 - V_CON4) / (V_P3 - V_P4)
      WHEN (NVL(V_P5,0) > 0 AND (V_P5 &lt;= VCE_COMP_REGULAR_DET.CRDETPOTENCIA) AND (VCE_COMP_REGULAR_DET.CRDETPOTENCIA &lt;= V_P4))
      THEN V_CON5 + (VCE_COMP_REGULAR_DET.CRDETPOTENCIA - V_P5) * (V_CON4 - V_CON5) / (V_P4 - V_P5)
      ELSE

      CASE WHEN GREATEST(NVL(V_P5,0),NVL(V_P4,0),NVL(V_P3,0),NVL(V_P2,0)) &lt; VCE_COMP_REGULAR_DET.CRDETPOTENCIA THEN
      CASE
      WHEN NVL(V_P2,0) > 0 THEN V_CON2 + (VCE_COMP_REGULAR_DET.CRDETPOTENCIA - V_P2) * (V_CON1 - V_CON2) / (V_P1 - V_P2)
      WHEN NVL(V_P3,0) > 0 THEN V_CON3 + (VCE_COMP_REGULAR_DET.CRDETPOTENCIA - V_P3) * (V_CON2 - V_CON3) / (V_P2 - V_P3)
      WHEN NVL(V_P4,0) > 0 THEN V_CON4 + (VCE_COMP_REGULAR_DET.CRDETPOTENCIA - V_P4) * (V_CON3 - V_CON4) / (V_P3 - V_P4)
      WHEN NVL(V_P5,0) > 0 THEN V_CON5 + (VCE_COMP_REGULAR_DET.CRDETPOTENCIA - V_P5) * (V_CON4 - V_CON5) / (V_P4 - V_P5)
      END
      ELSE
      CASE
      WHEN NVL(V_P5,0) > 0 THEN V_CON5 + (VCE_COMP_REGULAR_DET.CRDETPOTENCIA - V_P5) * (V_CON4 - V_CON5) / (V_P4 - V_P5)
      WHEN NVL(V_P4,0) > 0 THEN V_CON4 + (VCE_COMP_REGULAR_DET.CRDETPOTENCIA - V_P4) * (V_CON3 - V_CON4) / (V_P3 - V_P4)
      WHEN NVL(V_P3,0) > 0 THEN V_CON3 + (VCE_COMP_REGULAR_DET.CRDETPOTENCIA - V_P3) * (V_CON2 - V_CON3) / (V_P2 - V_P3)
      WHEN NVL(V_P2,0) > 0 THEN V_CON2 + (VCE_COMP_REGULAR_DET.CRDETPOTENCIA - V_P2) * (V_CON1 - V_CON2) / (V_P1 - V_P2)
      END
      END
      END AS CONSUMO
      FROM (
      SELECT DC.PECACODI,DC.GRUPOCODI,DC.CRDCGCONSIDERAPOTNOM,CRDCGFECMOD, DC.CRDCGPOTEFE AS V_P1,DC.CRDCGCCPOTEFE AS V_CON1,DC.CRDCGPOTPAR1 AS V_P2,DC.CRDCGCONCOMPP1 AS V_CON2,DC.CRDCGPOTPAR2  AS V_P3,DC.CRDCGCONCOMPP2 AS V_CON3,DC.CRDCGPOTPAR3 AS V_P4,DC.CRDCGCONCOMPP3 AS V_CON4,DC.CRDCGPOTPAR4  AS V_P5,DC.CRDCGCONCOMPP4  AS V_CON5
      FROM VCE_DATCALCULO DC
      WHERE DC.CRDCGFECMOD = TO_DATE('{1}','DD/MM/YYYY')
      AND NVL(DC.CRDCGCONSIDERAPOTNOM,0)!=1
      ) DATC WHERE DATC.PECACODI = VCE_COMP_REGULAR_DET.PECACODI AND DATC.GRUPOCODI = VCE_COMP_REGULAR_DET.GRUPOCODI
      )
      WHERE PECACODI = {0} AND GRUPOCODI = {2} AND CRDETHORA - 1/86400 >= TO_DATE('{1}','DD/MM/YYYY') AND CRDETPOTENCIA IS NOT NULL
      AND EXISTS (SELECT 1 FROM VCE_DATCALCULO DC
      WHERE DC.PECACODI = VCE_COMP_REGULAR_DET.PECACODI AND DC.GRUPOCODI = VCE_COMP_REGULAR_DET.GRUPOCODI AND DC.CRDCGFECMOD = TO_DATE('{1}','DD/MM/YYYY')
      AND NVL(DC.CRDCGCONSIDERAPOTNOM,0)!=1)

    </query>
  </Sql>

  <Sql>
    <key>ActualizarPotenciaEfectiva</key>
    <query>
		UPDATE VCE_COMP_REGULAR_DET SET (CRDETPOTENCIA,CRDETCONSUMOCOMB) =  (
		SELECT DC.CRDCGPOTEFE ,DC.CRDCGCCPOTEFE
		FROM VCE_DATCALCULO DC
		WHERE DC.PECACODI = VCE_COMP_REGULAR_DET.PECACODI AND DC.GRUPOCODI = VCE_COMP_REGULAR_DET.GRUPOCODI
		AND DC.CRDCGFECMOD = TO_DATE('{1}','DD/MM/YYYY')
		AND NVL(DC.CRDCGCONSIDERAPOTNOM,0)=1
		)
		WHERE PECACODI = {0} AND GRUPOCODI = {2} AND CRDETHORA - 1/86400 >= TO_DATE('{1}','DD/MM/YYYY') AND CRDETPOTENCIA IS NOT NULL
		AND EXISTS (SELECT 1 FROM VCE_DATCALCULO DC
		WHERE DC.PECACODI = VCE_COMP_REGULAR_DET.PECACODI AND DC.GRUPOCODI = VCE_COMP_REGULAR_DET.GRUPOCODI AND DC.CRDCGFECMOD = TO_DATE('{1}','DD/MM/YYYY')
		AND NVL(DC.CRDCGCONSIDERAPOTNOM,0)=1)
	</query>
  </Sql>

  <Sql>
    <key>ActualizarParametrosGenerador</key>
    <query>
      UPDATE VCE_COMP_REGULAR_DET SET (CRDETPRECIOAPLIC,CRDETLHV,CRDETCVNC) =  (
      SELECT DC.CRDCGPRECIOAPLIC,DC.CRDCGLHV,NVL(DC.CRDCGCVNCDOL*PE.PECATIPOCAMBIO,0)+NVL(DC.CRDCGCVNCSOL,0)
      FROM VCE_DATCALCULO DC JOIN VCE_PERIODO_CALCULO PE ON DC.PECACODI = PE.PECACODI
      WHERE DC.PECACODI = VCE_COMP_REGULAR_DET.PECACODI AND DC.GRUPOCODI = VCE_COMP_REGULAR_DET.GRUPOCODI
      AND DC.CRDCGFECMOD = TO_DATE('{1}','DD/MM/YYYY')
      )
      WHERE PECACODI = {0} AND GRUPOCODI = {2} AND CRDETHORA - 1/86400 >= TO_DATE('{1}','DD/MM/YYYY') AND CRDETPOTENCIA IS NOT NULL
      AND EXISTS (SELECT 1 FROM VCE_DATCALCULO DC
      WHERE DC.PECACODI = VCE_COMP_REGULAR_DET.PECACODI AND DC.GRUPOCODI = VCE_COMP_REGULAR_DET.GRUPOCODI AND DC.CRDCGFECMOD = TO_DATE('{1}','DD/MM/YYYY')    )
    </query>
  </Sql>


  <Sql>
    <key>ActualizarCVC</key>
    <query>
      UPDATE VCE_COMP_REGULAR_DET SET (CRDETCVC) = (SELECT CASE WHEN FENERGCODI IN (3,4) THEN VCE_COMP_REGULAR_DET.CRDETCONSUMOCOMB*VCE_COMP_REGULAR_DET.CRDETPRECIOAPLIC/(VCE_COMP_REGULAR_DET.CRDETPOTENCIA*1000)
      WHEN FENERGCODI IN (5) THEN VCE_COMP_REGULAR_DET.CRDETCONSUMOCOMB*VCE_COMP_REGULAR_DET.CRDETPRECIOAPLIC/(VCE_COMP_REGULAR_DET.CRDETPOTENCIA*1000)
      WHEN FENERGCODI IN (2) THEN VCE_COMP_REGULAR_DET.CRDETCONSUMOCOMB*VCE_COMP_REGULAR_DET.CRDETPRECIOAPLIC*(NVL(VCE_COMP_REGULAR_DET.CRDETLHV,0)/1000)/(VCE_COMP_REGULAR_DET.CRDETPOTENCIA * 1000000)
      ELSE NULL END
      FROM PR_GRUPO WHERE GRUPOCODI = VCE_COMP_REGULAR_DET.GRUPOCODI)
      WHERE PECACODI = {0} AND NVL(CRDETPOTENCIA,0)!=0
    </query>
  </Sql>

  <Sql>
    <key>ActualizarCVT</key>
    <query>
      UPDATE VCE_COMP_REGULAR_DET SET CRDETCVT = NVL(CRDETCVC,0)+NVL(CRDETCVNC,0)
      WHERE PECACODI = {0} AND NVL(CRDETPOTENCIA,0)!=0
    </query>
  </Sql>


  <Sql>
    <key>InicializarEnergiaSinCalificacion</key>
    <query>
      UPDATE VCE_COMP_REGULAR_DET SET CRDETVALOR=NULL,CRDETCVT=NULL,CRDETCMG=NULL,CRDETCOMPENSACION=NULL
      WHERE PECACODI = {0} AND CRDETVALOR IS NOT NULL AND SUBCAUSACODI IS NULL
    </query>
  </Sql>

  <Sql>
    <key>ListGrupoCodi</key>
    <query>
      SELECT DISTINCT GRUPOCODI
      FROM VCE_COSTO_VARIABLE
      WHERE pecacodi = {0}
      
    </query>
  </Sql>

</Sqls>

