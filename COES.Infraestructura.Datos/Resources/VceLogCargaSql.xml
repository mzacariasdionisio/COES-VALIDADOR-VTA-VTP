<?xml version="1.0" encoding="utf-8" ?>

<Sqls>

  <Sql>
		<key>List</key>
		<query>
      SELECT L.pecacodi,L.VCELCBORDEN,L.VCELCBENTIDAD,L.VCELCBNROREGISTROS,L.VCELCBHORAULTCARGA,L.VCELCBNOMBTABLA,FA.FECULTACTUALIZACION
      FROM VCE_LOG_CARGA_CAB L LEFT JOIN (SELECT 'VCE_ENERGIA' AS VCELCBNOMBTABLA, MAX(ENVIOFECHA) AS FECULTACTUALIZACION FROM ME_ENVIO WHERE FORMATCODI = 1 AND TO_CHAR(ENVIOFECHAPERIODO,'YYYYMM') = (SELECT PERIANIOMES FROM TRN_PERIODO PE JOIN VCE_PERIODO_CALCULO PC ON PE.PERICODI = PC.PERICODI WHERE pecacodi = {0})
      UNION
      SELECT 'VCE_HORA_OPERACION', MAX(LASTDATE) FROM EVE_HORAOPERACION WHERE TO_CHAR(HOPHORINI,'YYYYMM') = (SELECT PERIANIOMES FROM TRN_PERIODO PE JOIN VCE_PERIODO_CALCULO PC ON PE.PERICODI = PC.PERICODI WHERE pecacodi = {0})
      UNION
      SELECT 'VCE_DATCALCULO', MAX(FECHAACT) FROM PR_GRUPODAT  WHERE TO_CHAR(FECHADAT,'YYYYMM') = (SELECT PERIANIOMES FROM TRN_PERIODO PE JOIN VCE_PERIODO_CALCULO PC ON PE.PERICODI = PC.PERICODI WHERE pecacodi = {0})
      ) FA ON L.VCELCBNOMBTABLA = FA.VCELCBNOMBTABLA
      WHERE L.pecacodi = {0} AND L.VCELCBNOMBTABLA != 'TRN_COSTO_MARGINAL'
      UNION ALL
      SELECT L.pecacodi,L.VCELCBORDEN,L.VCELCBENTIDAD,FA.NROREGS VCELCBNROREGISTROS,NULL AS VCELCBHORAULTCARGA,L.VCELCBNOMBTABLA,FA.FECULTACTUALIZACION
      FROM VCE_LOG_CARGA_CAB L LEFT JOIN (
      SELECT 'TRN_COSTO_MARGINAL' VCELCBNOMBTABLA,COUNT(*) AS NROREGS, MAX(COSMARFECINS) AS FECULTACTUALIZACION FROM TRN_COSTO_MARGINAL CM JOIN VCE_PERIODO_CALCULO PE ON CM.PERICODI = PE.PERICODI AND CM.COSMARVERSION = PE.PECAVERSIONVTEA WHERE PE.pecacodi = {0}
      ) FA ON L.VCELCBNOMBTABLA = FA.VCELCBNOMBTABLA
      WHERE L.pecacodi = {0} AND L.VCELCBNOMBTABLA = 'TRN_COSTO_MARGINAL'
      ORDER BY 1,2
    </query>
	</Sql>

  <Sql>
    <key>Init</key>
    <query>
      INSERT INTO VCE_LOG_CARGA_CAB(pecacodi,VCELCBORDEN,VCELCBNOMBTABLA,VCELCBENTIDAD)
      SELECT {0} AS pecacodi,1 AS VCELCBORDEN,'VCE_ENERGIA' AS VCELCBNOMBTABLA,'Energía' AS VCELCBENTIDAD  FROM DUAL
      UNION
      SELECT {0} AS pecacodi,2 AS VCELCBORDEN,'TRN_COSTO_MARGINAL' AS VCELCBNOMBTABLA,'Costo Marginal' AS VCELCBENTIDAD  FROM DUAL
      UNION
      SELECT {0} AS pecacodi,3 AS VCELCBORDEN,'VCE_HORA_OPERACION' AS VCELCBNOMBTABLA,'Horas de Operación' AS VCELCBENTIDAD  FROM DUAL
      UNION
      SELECT {0} AS pecacodi,4 AS VCELCBORDEN,'VCE_DATCALCULO' AS VCELCBNOMBTABLA,'Parámetros Generación' AS VCELCBENTIDAD  FROM DUAL
    </query>
  </Sql>

  <Sql>
    <key>ActualizarCampos</key>
    <query>
      UPDATE VCE_LOG_CARGA_CAB
      SET VCELCBNROREGISTROS = (SELECT COUNT(*) FROM {0} WHERE pecacodi = {1}),
      VCELCBHORAULTCARGA = SYSDATE WHERE pecacodi = {1} AND VCELCBNOMBTABLA = '{0}'
    </query>
  </Sql>

</Sqls>

